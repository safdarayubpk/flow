# Implementation Plan: OCI OKE Cloud Deployment

**Branch**: `008-oci-oke-cloud-deployment` | **Date**: 2026-02-19 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/008-oci-oke-cloud-deployment/spec.md`

## Summary

Deploy the full Flow Todo application stack (FastAPI backend, Next.js frontend, Dapr pub/sub, Kafka) to an existing OCI OKE cluster in me-dubai-1 using existing Helm charts with OCI-specific value overrides. The deployment targets a single free-tier VM.Standard.E2.1 node (1 OCPU, 8GB RAM) and uses NGINX Ingress Controller with an OCI Load Balancer for external access. All operations require MFA session-based authentication.

## Technical Context

**Language/Version**: Python 3.13+ (backend), TypeScript/JavaScript (frontend), YAML (Kubernetes manifests), Bash (deployment scripts)
**Primary Dependencies**: FastAPI, SQLModel, Next.js 16+, Better Auth, Helm v4.1.0, kubectl v1.35+, Dapr CLI, OCI CLI
**Storage**: Neon PostgreSQL (external, existing), OCI Block Volume (5Gi PVC for Kafka data via `oci-bv` StorageClass)
**Testing**: Manual verification via kubectl, curl, browser — no automated test framework for deployment
**Target Platform**: OCI OKE (Oracle Kubernetes Engine), me-dubai-1 region, Kubernetes v1.32.1
**Project Type**: Web application (monorepo: backend/ + frontend/ + k8s/)
**Performance Goals**: Application accessible via public IP, backend health check returns HTTP 200, task CRUD completes successfully
**Constraints**: Single node (1 OCPU / 8GB RAM), ~578m CPU request budget / ~1364Mi RAM request budget, MFA session expires ~1hr, HTTP-only (no TLS), no CI/CD
**Scale/Scope**: Single cluster, single namespace (default), 1 replica each, single operator

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
| --------- | ------ | ----- |
| I. Spec-Driven Development | PASS | spec.md complete with 14 FRs, 8 SCs, clarifications resolved |
| II. AI-Only Implementation | PASS | All manifests, values files, and template changes generated by Claude Code |
| III. Iterative Evolution | PASS | Phase V.4 builds on Phase IV (Minikube) and V.3 (Dapr). Pivoted from DOKS to OKE. |
| IV. Reusability and Modularity | PASS | Existing Helm charts reused via values-oci.yaml overrides; Dapr component CRD reused from local dev |
| V. Security and Isolation | PASS | Secrets in K8s Secrets (not committed), JWT auth via Better Auth preserved, user isolation unchanged |
| VI. Cloud-Native Readiness | PASS | Full K8s deployment with ingress, Dapr sidecars, Kafka pub/sub, health checks, graceful degradation |

No violations. All gates pass.

## Project Structure

### Documentation (this feature)

```text
specs/008-oci-oke-cloud-deployment/
├── plan.md              # This file
├── spec.md              # Feature specification (complete)
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output (deployment topology)
├── quickstart.md        # Phase 1 output (deployment runbook)
├── contracts/           # Phase 1 output (K8s manifest contracts)
│   ├── kafka.yaml
│   ├── dapr-kafka-pubsub.yaml
│   ├── ingress.yaml
│   ├── values-oci-backend.yaml
│   └── values-oci-frontend.yaml
├── checklists/
│   └── requirements.md  # Quality checklist (complete)
└── tasks.md             # Phase 2 output (/sp.tasks)
```

### Source Code (repository root)

```text
k8s/
├── backend/                    # Existing Helm chart (modify: add podAnnotations to template)
│   ├── Chart.yaml
│   ├── values.yaml             # Default values (unchanged)
│   ├── values-oci.yaml         # NEW: OCI-specific overrides
│   └── templates/
│       ├── deployment.yaml     # MODIFY: add podAnnotations support
│       ├── service.yaml
│       ├── configmap.yaml
│       └── _helpers.tpl
├── frontend/                   # Existing Helm chart (modify: add BETTER_AUTH_URL env)
│   ├── Chart.yaml
│   ├── values.yaml             # Default values (unchanged)
│   ├── values-oci.yaml         # NEW: OCI-specific overrides
│   └── templates/
│       ├── deployment.yaml     # MODIFY: add BETTER_AUTH_URL env support
│       ├── service.yaml
│       ├── configmap.yaml
│       └── _helpers.tpl
├── kafka.yaml                  # NEW: Kafka + Zookeeper Deployments, Services, PVC
├── dapr-kafka-pubsub.yaml      # NEW: Dapr Component CRD for Kafka pub/sub
└── ingress.yaml                # NEW: NGINX Ingress with routing rules
```

**Structure Decision**: Extend the existing `k8s/` directory with new manifest files and values overrides. Two existing Helm templates get minimal additions (podAnnotations block, BETTER_AUTH_URL env). No new directories outside `k8s/` are created. The `contracts/` directory under specs holds the canonical YAML definitions that get copied to `k8s/` during implementation.

## Architecture Decisions

### AD-1: Ingress Path Routing with Rewrite

The ingress uses regex path matching with `rewrite-target: /$2` to strip the `/api` prefix when forwarding to the backend. Path `/api(/|$)(.*)` captures everything after `/api` and forwards it as `/$2`. The backend's health endpoint is at `/health` (not `/api/health`), so the rewrite correctly maps `http://<LB_IP>/api/health` → backend `/health`.

The frontend catch-all path `/(.*)` forwards everything else to the frontend service.

### AD-2: Dapr Sidecar via Pod Annotations

Rather than modifying the Helm chart substantially, Dapr sidecar injection is controlled via pod annotations set in `values-oci.yaml`. This requires a one-line template addition (`podAnnotations` support) to `deployment.yaml`. The sidecar resource limits are set via annotations (10m CPU / 32Mi RAM request) to fit the free-tier budget.

### AD-3: Kafka as Simple Deployment (not StatefulSet)

For a single-broker hackathon setup, a Deployment with a PVC is simpler than a StatefulSet. There's no need for stable pod identity or ordered scaling when running exactly 1 replica. The PVC (`oci-bv` StorageClass, 5Gi) provides data persistence across pod restarts.

### AD-4: OCI Load Balancer Annotations

The NGINX Ingress Controller service uses OCI-specific annotations for flexible LB shape (10Mbps min/max) and explicit LB subnet placement. The `oci.oraclecloud.com/load-balancer-type: lb` annotation ensures a standard load balancer (not NLB). Admission webhooks are disabled to save resources.

### AD-5: NEXT_PUBLIC_API_URL Runtime Consideration

`NEXT_PUBLIC_*` variables in Next.js are normally baked at build time. The Docker image was built with a different value. For OKE, the runtime `NEXT_PUBLIC_API_URL` env var is set in the pod, which works for server-side rendering but may not affect client-side JavaScript. If client-side API calls fail, the image may need rebuilding with the correct URL. This is a known risk documented in the quickstart.

### AD-6: Graceful Degradation for Kafka/Dapr

The backend's existing Dapr publisher code already handles the case where the Dapr sidecar is unavailable (skips publishing with log warning). This means the deployment order is flexible — the backend can start before Kafka is fully ready. No code changes needed for this behavior.

## Deployment Dependency Graph

```text
Step 0: Verify Cluster Access
  │
Step 1: Add Helm Repos
  │
Step 2: Install NGINX Ingress ──→ Step 3: Wait for LB IP
  │                                        │
Step 4: Install Dapr                       │
  │                                        │
Step 5: Deploy Kafka + Zookeeper           │
  │                                        │
Step 6: Deploy Dapr Component CRD          │
  │                                        │
Step 7: Create K8s Secrets                 │
  │                                        │
  ├────────────────────────────────────────┘
  │
Step 8-9: Create values-oci.yaml (with LB_IP substituted)
  │
Step 10: Helm install backend ──→ Step 11: Helm install frontend
  │
Step 12: Apply Ingress
  │
Step 13: Verify end-to-end
```

Steps 2-7 have a linear dependency on Step 1 but are parallelizable among themselves (except Step 3 depends on Step 2, and Step 6 depends on Step 4). Steps 8-9 depend on Step 3 (LB IP known) and Step 7 (secrets exist). Steps 10-12 are strictly sequential.

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
| ---- | ---------- | ------ | ---------- |
| OCI LB provisioning slow (>5 min) | Medium | Low | Wait patiently; LB provisioning is async |
| Node OOM with all components | Low | High | Resource budget validated at ~1364Mi / 8192Mi (17%). Safe margin. |
| `NEXT_PUBLIC_API_URL` baked at build time | Medium | Medium | Test client-side API calls; rebuild image if needed |
| MFA session expires mid-deployment | High | Low | Document refresh at every step; idempotent commands |
| Kafka fails to start (x86 image on x86 node) | Low | Medium | Using official Confluent images; verified compatible |
| Ingress service name mismatch | Medium | Medium | Verify with `kubectl get svc` before applying ingress |

## Complexity Tracking

No constitution violations requiring justification. All decisions follow existing patterns (Helm charts, Dapr, Kafka) established in prior phases.
